<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë©´ì ‘ ì§„í–‰ â€” ì••ë°•ë©´ì ‘ ì‹œë®¬ë ˆì´í„°</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* â”€â”€ ì „ì²´ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body { display:flex; flex-direction:column; height:100vh; overflow:hidden; }
.interview-layout {
  flex:1; display:grid;
  grid-template-rows: auto 1fr auto;
  gap:0; overflow:hidden;
}

/* â”€â”€ ìƒë‹¨ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.top-bar {
  display:flex; align-items:center; gap:10px;
  padding:10px 16px; background:var(--bg-card);
  border-bottom:1px solid var(--border); flex-shrink:0;
}
.session-info { font-size:12px; color:var(--text-sub); }
.top-controls { margin-left:auto; display:flex; gap:8px; align-items:center; }

/* â”€â”€ ë©”ì¸ ì½˜í…ì¸  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-content {
  display:grid;
  grid-template-columns: 1fr 220px;
  gap:12px;
  padding:12px 16px;
  overflow:hidden;
}
@media(max-width:700px){
  .main-content { grid-template-columns:1fr; grid-template-rows:1fr auto; }
}

/* â”€â”€ ë©´ì ‘ê´€ íŒ¨ë„ ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.interviewer-area {
  display:flex; flex-direction:column; gap:10px; overflow:hidden;
}

.avatar-panel-row {
  display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
}

/* ë©´ì ‘ê´€ ì•„ë°”íƒ€ ê°œì„  */
.avatar-card { position:relative; }
.avatar-card .speak-ring {
  position:absolute; inset:-4px; border-radius:50%; border:2px solid transparent;
  transition:border-color .2s;
}
.avatar-card.speaking .speak-ring { border-color:var(--accent); animation:speakPulse 1s infinite; }
@keyframes speakPulse {
  0%,100%{box-shadow:0 0 0 0 rgba(79,142,247,.4)}
  50%{box-shadow:0 0 0 6px rgba(79,142,247,0)}
}

/* â”€â”€ ìë§‰ ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.subtitle-area { flex:1; display:flex; flex-direction:column; gap:8px; overflow:hidden; }

.q-label {
  font-size:10px; font-weight:700; color:var(--text-dim);
  text-transform:uppercase; letter-spacing:.08em;
}
.interviewer-bubble {
  background:var(--bg-card2); border:1px solid var(--border);
  border-radius:12px; padding:14px 16px;
  font-size:15px; line-height:1.75; min-height:60px;
  flex-shrink:0;
}
.interviewer-bubble.speaking { border-color:var(--accent); box-shadow:0 0 12px rgba(79,142,247,.2); }

.user-answer-area {
  flex:1; background:rgba(79,142,247,.05);
  border:1px solid rgba(79,142,247,.2);
  border-radius:12px; padding:12px 14px;
  font-size:13px; color:var(--text-sub);
  overflow-y:auto; min-height:60px;
}
.user-answer-area.listening {
  border-color:var(--success); background:rgba(67,201,123,.05);
}

/* â”€â”€ ì‹¤ì‹œê°„ í”¼ë“œë°± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.realtime-feedback {
  padding:6px 12px; border-radius:8px;
  background:rgba(224,154,58,.15); border:1px solid rgba(224,154,58,.3);
  font-size:11px; color:var(--warn); font-weight:600;
  display:none;
}
.realtime-feedback.show { display:block; }

/* â”€â”€ ìš°ì¸¡ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.right-panel { display:flex; flex-direction:column; gap:10px; }

.pip-camera {
  width:100%; aspect-ratio:4/3; background:#111;
  border-radius:10px; overflow:hidden; position:relative;
  border:2px solid var(--border);
}
.pip-camera video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
.pip-label { position:absolute; bottom:4px; left:6px; font-size:9px; color:#fff;
             background:rgba(0,0,0,.6); padding:1px 6px; border-radius:8px; }

/* íƒ€ì´ë¨¸ */
.timer-section { text-align:center; }

/* ì§„í–‰ ìƒí™© */
.progress-section { }
.q-progress-text { font-size:11px; color:var(--text-sub); margin-bottom:4px; }

/* â”€â”€ í•˜ë‹¨ ì»¨íŠ¸ë¡¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-bar {
  display:flex; align-items:center; gap:10px;
  padding:10px 16px; background:var(--bg-card);
  border-top:1px solid var(--border); flex-shrink:0;
}
.bottom-bar .spacer { flex:1; }

/* í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë“œ */
.text-input-row {
  flex:1; display:flex; gap:8px;
}
.text-input-row input {
  flex:1; padding:8px 12px; font-size:13px;
  border-radius:8px;
}

/* â”€â”€ ì˜¤ë²„ë ˆì´ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,.75);
  display:flex; align-items:center; justify-content:center;
  z-index:200; backdrop-filter:blur(4px);
}
.overlay-box {
  background:var(--bg-card); border-radius:16px;
  padding:28px 32px; max-width:400px; width:90%;
  text-align:center;
}
.overlay-box h2 { font-size:20px; margin-bottom:12px; }
.overlay-box p  { font-size:13px; color:var(--text-sub); margin-bottom:20px; }
.overlay-box .btn-row { display:flex; gap:10px; justify-content:center; }

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.spinner {
  width:24px; height:24px; border:3px solid var(--border);
  border-top-color:var(--accent); border-radius:50%;
  animation:spin .8s linear infinite; display:inline-block;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ì•ˆì „ ì¥ì¹˜ */
#safety-overlay .overlay-box { border:1px solid var(--warn); }
</style>
</head>
<body>

<div class="interview-layout">

  <!-- â”€â”€ ìƒë‹¨ ë°” â”€â”€ -->
  <div class="top-bar">
    <span class="session-info">
      <span class="badge" id="diff-badge">ì¤‘</span>
      <span id="q-counter" style="margin-left:8px;font-size:12px">Q 1 / 8</span>
    </span>
    <span id="session-elapsed" style="font-size:12px;color:var(--text-dim);margin-left:8px">00:00</span>
    <div class="top-controls">
      <button class="btn btn-warn" style="padding:6px 12px;font-size:12px"
        onclick="onReducePressure()">ğŸ˜®â€ğŸ’¨ ì••ë°• ì™„í™”</button>
      <button class="btn btn-ghost" style="padding:6px 12px;font-size:12px"
        id="btn-pause" onclick="togglePause()">â¸ ì¼ì‹œì •ì§€</button>
      <button class="btn btn-danger" style="padding:6px 12px;font-size:12px"
        onclick="confirmAbort()">â¹ ì¢…ë£Œ</button>
    </div>
  </div>

  <!-- â”€â”€ ë©”ì¸ ì½˜í…ì¸  â”€â”€ -->
  <div class="main-content">

    <!-- ë©´ì ‘ê´€ + ìë§‰ -->
    <div class="interviewer-area">

      <!-- ë©´ì ‘ê´€ ì•„ë°”íƒ€ íŒ¨ë„ -->
      <div class="avatar-panel-row" id="avatar-panel"></div>

      <!-- ì‹¤ì‹œê°„ í”¼ë“œë°± -->
      <div class="realtime-feedback" id="realtime-feedback"></div>

      <!-- ë©´ì ‘ê´€ ë°œí™” ìë§‰ -->
      <div class="q-label">ë©´ì ‘ê´€ ë°œí™”</div>
      <div class="interviewer-bubble" id="interviewer-bubble">
        <span class="spinner"></span> ë©´ì ‘ê´€ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...
      </div>

      <!-- ì‚¬ìš©ì ë‹µë³€ -->
      <div class="q-label" style="margin-top:4px">ë‚´ ë‹µë³€ <span id="listen-indicator"></span></div>
      <div class="user-answer-area" id="user-answer-area">
        ë‹µë³€ì„ ì¤€ë¹„í•´ ì£¼ì„¸ìš”...
      </div>

    </div>

    <!-- ìš°ì¸¡ íŒ¨ë„ -->
    <div class="right-panel">

      <!-- ì¹´ë©”ë¼ PIP -->
      <div class="pip-camera" id="pip-camera">
        <video id="pip-video" autoplay muted playsinline></video>
        <div class="pip-label" id="pip-label">ë‚˜</div>
      </div>
      <div style="font-size:10px;color:var(--text-dim);text-align:center;margin-top:2px"
           id="face-status-text">ì–¼êµ´ ê°ì§€ ì¤€ë¹„ ì¤‘...</div>

      <!-- íƒ€ì´ë¨¸ -->
      <div class="timer-section">
        <div style="font-size:10px;color:var(--text-dim);margin-bottom:6px">ë‹µë³€ ì‹œê°„</div>
        <div class="timer-ring" id="timer-ring">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="track" cx="32" cy="32" r="28"/>
            <circle class="fill"  cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="timer-text" id="timer-text">--</div>
        </div>
      </div>

      <!-- ì§„í–‰ í˜„í™© -->
      <div class="progress-section">
        <div class="q-progress-text" id="q-progress-text">ì§ˆë¬¸ 1 / 8</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
      </div>

      <!-- í•„ëŸ¬ì›Œë“œ ì‹¤ì‹œê°„ ì¹´ìš´í„° -->
      <div style="background:var(--bg-card2);border:1px solid var(--border);
                  border-radius:8px;padding:10px;font-size:11px">
        <div style="color:var(--text-dim);margin-bottom:4px">ë°˜ë³µì–´ ê°ì§€</div>
        <div id="filler-count" style="font-size:20px;font-weight:800;color:var(--accent)">0</div>
        <div style="color:var(--text-dim)">íšŒ (ëˆ„ì )</div>
      </div>

    </div>
  </div>

  <!-- â”€â”€ í•˜ë‹¨ ì»¨íŠ¸ë¡¤ â”€â”€ -->
  <div class="bottom-bar">
    <!-- í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë“œ -->
    <div class="text-input-row" id="text-input-row" style="display:none">
      <input type="text" id="text-answer-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500"
        onkeydown="if(event.key==='Enter')submitTextAnswer()">
      <button class="btn btn-primary" onclick="submitTextAnswer()">ë‹µë³€ ì „ì†¡</button>
    </div>
    <!-- ìŒì„± ëª¨ë“œ -->
    <div id="voice-status" style="font-size:12px;color:var(--text-sub)"></div>
    <div class="spacer"></div>
    <button class="btn btn-ghost" style="padding:6px 12px;font-size:12px"
      id="btn-skip" onclick="skipQuestion()" disabled>ì§ˆë¬¸ ê±´ë„ˆëœ€ â†’</button>
  </div>

</div>

<!-- â”€â”€ ì˜¤ë²„ë ˆì´: ì¼ì‹œì •ì§€ â”€â”€ -->
<div class="overlay" id="pause-overlay" style="display:none">
  <div class="overlay-box">
    <h2>â¸ ì¼ì‹œì •ì§€</h2>
    <p>ë©´ì ‘ì´ ì¼ì‹œì •ì§€ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì¤€ë¹„ê°€ ë˜ë©´ ì¬ê°œí•˜ì„¸ìš”.</p>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="togglePause()">â–¶ ì¬ê°œ</button>
      <button class="btn btn-danger"  onclick="confirmAbort()">ì¢…ë£Œ</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ì˜¤ë²„ë ˆì´: ì¢…ë£Œ í™•ì¸ â”€â”€ -->
<div class="overlay" id="abort-overlay" style="display:none">
  <div class="overlay-box">
    <h2>ë©´ì ‘ì„ ì¢…ë£Œí• ê¹Œìš”?</h2>
    <p>ì§€ê¸ˆê¹Œì§€ì˜ ë‹µë³€ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
    <div class="btn-row">
      <button class="btn btn-ghost"   onclick="closeAbortDialog()">ê³„ì†í•˜ê¸°</button>
      <button class="btn btn-danger"  onclick="abortSession()">ì¢…ë£Œí•˜ê³  ë¦¬í¬íŠ¸ ë³´ê¸°</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ì˜¤ë²„ë ˆì´: ì•ˆì „ ì¥ì¹˜ (FR-110) â”€â”€ -->
<div class="overlay" id="safety-overlay" style="display:none">
  <div class="overlay-box" style="border:1px solid var(--warn)">
    <h2>ğŸ’› ì ê¹, ê´œì°®ìœ¼ì„¸ìš”?</h2>
    <p id="safety-msg">ì••ë°• ê°•ë„ê°€ ë†’ìŠµë‹ˆë‹¤.<br>ì ì‹œ ì‰¬ì–´ê°€ë„ ë©ë‹ˆë‹¤.</p>
    <div class="btn-row">
      <button class="btn btn-warn"    onclick="closeSafety()">ê³„ì†í•˜ê¸°</button>
      <button class="btn btn-ghost"   onclick="onReducePressure(); closeSafety()">ì••ë°• ë‚®ì¶”ê¸°</button>
      <button class="btn btn-danger"  onclick="abortSession()">ì¦‰ì‹œ ì¢…ë£Œ</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ì˜¤ë²„ë ˆì´: ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ â”€â”€ -->
<div class="overlay" id="loading-overlay" style="display:none">
  <div class="overlay-box">
    <div class="spinner" style="width:40px;height:40px;margin:0 auto 16px"></div>
    <h2>ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...</h2>
    <p>AIê°€ ë‹µë³€ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
  </div>
</div>

<div id="toast-container"></div>

<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/questions.js"></script>
<script src="js/speech.js"></script>
<script src="js/face.js"></script>
<script src="js/llm.js"></script>

<script>
// ===================================================
//  ë©´ì ‘ ì„¸ì…˜ ë©”ì¸ ë¡œì§
// ===================================================

const config = APP.getSessionConfig();
const diffLevel = { easy:0, medium:1, hard:2 }[config.difficulty] ?? 1;

// ìƒíƒœ
let sessionState   = 'idle';   // idle | speaking | listening | processing | done
let questions      = [];
let currentQIdx    = 0;
let activePanel    = [];
let currentSpeaker = '';
let answerRecords  = [];
let currentAnswer  = null;
let timerInterval  = null;
let elapsedInterval = null;
let timerRemaining = 0;
let sessionElapsed = 0;
let totalFillerCount = 0;
let isPaused       = false;
let pressureReduced = false;

let faceService = null;
let gazeScores  = [];

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = async () => {
  setupBadge();
  setupPanel();
  setupQuestions();
  await setupCamera();
  setupSpeech();
  startElapsedTimer();

  if (config.typingMode) {
    document.getElementById('text-input-row').style.display = 'flex';
  }

  // ì„¸ì…˜ ì‹œì‘
  await runOpeningRemark();
  runInterviewLoop();
};

window.onunload = () => { faceService?.stopCamera(); };

function setupBadge() {
  const labels = { easy:'í•˜', medium:'ì¤‘', hard:'ìƒ' };
  const el = document.getElementById('diff-badge');
  el.textContent = labels[config.difficulty] || 'ì¤‘';
  el.className = `badge badge-${config.difficulty}`;
}

function setupPanel() {
  const pools = APP.difficultyPanels[config.difficulty];
  activePanel = pools[Math.floor(Math.random() * pools.length)].slice();
  renderAvatarPanel();
}

function setupQuestions() {
  questions = getQuestions(config.difficulty, 8);
  updateProgress();
}

async function setupCamera() {
  if (config.subtitleOnly) return;
  const videoEl = document.getElementById('pip-video');
  faceService = new FaceDetectionService(videoEl, null);
  const ok = await faceService.startCamera();
  if (ok) {
    faceService.onResult = onFaceResult;
    faceService.initFaceMesh();
  } else {
    document.getElementById('pip-camera').style.display = 'none';
  }
}

function setupSpeech() {
  speechService.onPartial = (t) => {
    if (sessionState !== 'listening') return;
    document.getElementById('user-answer-area').textContent = t + '...';
    updateFillerCount(t);
  };
  speechService.onFinal = (t) => {
    if (sessionState !== 'listening') return;
    document.getElementById('user-answer-area').textContent = t;
    updateFillerCount(t);
  };
}

// â”€â”€ ì•„ë°”íƒ€ íŒ¨ë„ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAvatarPanel() {
  const container = document.getElementById('avatar-panel');
  container.innerHTML = activePanel.map(id => {
    const iw = APP.interviewers[id];
    return `<div class="avatar-card" id="avatar-${id}">
      <div class="avatar-face">${iw?.emoji || 'ğŸ‘¤'}</div>
      <div class="avatar-name">${iw?.name || id}</div>
      <div class="avatar-role">${iw?.role || ''}</div>
    </div>`;
  }).join('');
}

function setActiveSpeaker(speakerId) {
  currentSpeaker = speakerId;
  document.querySelectorAll('.avatar-card').forEach(el => el.classList.remove('speaking'));
  const el = document.getElementById('avatar-' + speakerId);
  if (el) el.classList.add('speaking');
}

function clearActiveSpeaker() {
  document.querySelectorAll('.avatar-card').forEach(el => el.classList.remove('speaking'));
  currentSpeaker = '';
}

// â”€â”€ ì¸í„°ë·° ë£¨í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runOpeningRemark() {
  const speaker = 'chairperson';
  setActiveSpeaker(speaker);
  setBubble('ë©´ì ‘ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤. ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ?', true);
  if (!config.subtitleOnly) {
    await speechService.speak('ë©´ì ‘ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤. ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ?', 'authority');
  }
  clearActiveSpeaker();
}

async function runInterviewLoop() {
  for (let i = 0; i < questions.length; i++) {
    if (sessionState === 'done') break;
    await waitIfPaused();

    currentQIdx = i;
    updateProgress();

    const q = questions[i];
    const speaker = selectSpeaker(q);

    // ë©´ì ‘ê´€ ì§ˆë¬¸
    await askQuestion(q, speaker);
    if (sessionState === 'done') break;

    // ì‚¬ìš©ì ë‹µë³€ ëŒ€ê¸°
    const record = await waitForAnswer(q);
    answerRecords.push(record);

    // ê¼¬ë¦¬ì§ˆë¬¸ ì—¬ë¶€
    const followUpChance = APP.followUpChance[config.difficulty];
    if (Math.random() < followUpChance && !isPaused && sessionState !== 'done') {
      await runFollowUp(speaker, record);
      if (sessionState === 'done') break;
      const followRecord = await waitForAnswer(null);
      answerRecords.push(followRecord);
    }

    // ìƒ ë‚œì´ë„: ë©´ì ‘ê´€ ê°„ í† ë¡  ì—°ì¶œ (30%)
    if (config.difficulty === 'hard' && Math.random() < 0.3 && sessionState !== 'done') {
      await runDebate(speaker);
    }

    await sleep(800);
  }

  if (sessionState !== 'done') finalizeSession();
}

// â”€â”€ ì§ˆë¬¸ ë°œí™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function askQuestion(q, speaker) {
  sessionState = 'processing';
  setBubble('<span class="spinner"></span> ì§ˆë¬¸ ìƒì„± ì¤‘...', false);
  setActiveSpeaker(speaker);
  document.getElementById('btn-skip').disabled = true;

  try {
    const resp = await claudeAgent.generateResponse({
      userAnswer: currentQIdx === 0 ? null : (answerRecords.at(-1)?.answerText || null),
      panel: activePanel,
      speaker,
      difficulty: config.difficulty,
      mode: config.mode,
    });

    await speakResponse(resp, speaker);
  } catch (err) {
    // API ì‹¤íŒ¨ â†’ ê¸°ë³¸ ì§ˆë¬¸ ì‚¬ìš©
    const fallback = { speech: q.text, expression: 'neutral', action: 'none' };
    await speakResponse(fallback, speaker);
    showToast('AI ì—°ê²° ì‹¤íŒ¨. ê¸°ë³¸ ì§ˆë¬¸ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'warn');
  }
}

async function runFollowUp(speaker, prevRecord) {
  sessionState = 'processing';
  setBubble('<span class="spinner"></span> ê¼¬ë¦¬ì§ˆë¬¸ ìƒì„± ì¤‘...', false);
  setActiveSpeaker(speaker);

  try {
    const resp = await claudeAgent.generateResponse({
      userAnswer: prevRecord.answerText || '(ë‹µë³€ ì—†ìŒ)',
      panel: activePanel,
      speaker,
      difficulty: config.difficulty,
      mode: config.mode,
    });
    await speakResponse(resp, speaker);
  } catch {
    const q = questions[currentQIdx];
    const fu = q.followUps?.[0] || 'ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ ì£¼ì‹œê² ì–´ìš”?';
    await speakResponse({ speech: fu, expression: 'suspicious', action: 'followup' }, speaker);
  }
}

async function runDebate(prevSpeaker) {
  const otherSpeakers = activePanel.filter(id => id !== prevSpeaker);
  if (!otherSpeakers.length) return;
  const debater = otherSpeakers[Math.floor(Math.random() * otherSpeakers.length)];
  setActiveSpeaker(debater);
  try {
    const resp = await claudeAgent.generateResponse({
      userAnswer: '(ë©´ì ‘ê´€ ê°„ ì˜ê²¬ êµí™˜ì„ ì§§ê²Œ ì—°ì¶œí•´ì£¼ì„¸ìš”)',
      panel: activePanel, speaker: debater,
      difficulty: config.difficulty, mode: config.mode,
    });
    setBubble(resp.speech, false);
    if (!config.subtitleOnly) {
      await speechService.speak(resp.speech, APP.interviewers[debater]?.voice || 'neutral');
    }
    await sleep(500);
  } catch {}
  clearActiveSpeaker();
}

async function speakResponse(resp, speaker) {
  const bubble = document.getElementById('interviewer-bubble');
  bubble.classList.add('speaking');
  await typeText(bubble, resp.speech || '...', 25);
  bubble.classList.remove('speaking');

  setActiveSpeaker(speaker);
  if (!config.subtitleOnly) {
    const voice = APP.interviewers[speaker]?.voice || 'neutral';
    await speechService.speak(resp.speech, voice);
  } else {
    await sleep(resp.speech.length * 60); // ì½ëŠ” ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜
  }
  clearActiveSpeaker();

  // interrupt ì•¡ì…˜ â†’ ì•ˆì „ ì¥ì¹˜
  if (resp.action === 'interrupt' && config.difficulty === 'hard') {
    showSafety('ë©´ì ‘ê´€ì´ ë‹µë³€ì„ ëŠì—ˆìŠµë‹ˆë‹¤. í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ë§í•´ë³´ì„¸ìš”.');
  }
}

// â”€â”€ ì‚¬ìš©ì ë‹µë³€ ëŒ€ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function waitForAnswer(q) {
  return new Promise(resolve => {
    currentAnswer = {
      questionText: q?.text || '(ê¼¬ë¦¬ì§ˆë¬¸)',
      answerText: '',
      duration: 0,
      fillerCount: 0,
      hasConclusion: false, hasEvidence: false, hasExample: false,
      gazeRatio: 0,
    };

    document.getElementById('user-answer-area').textContent = 'ë‹µë³€ì„ ì‹œì‘í•˜ì„¸ìš”...';
    document.getElementById('user-answer-area').classList.add('listening');
    document.getElementById('btn-skip').disabled = false;
    document.getElementById('listen-indicator').innerHTML =
      '<span class="status-dot ok pulse" style="margin-left:4px"></span>';

    sessionState = 'listening';
    const startTime = Date.now();

    // ìŒì„± ëª¨ë“œ
    if (!config.typingMode) {
      speechService.transcript = '';
      const started = speechService.startListening();
      if (started) {
        document.getElementById('voice-status').textContent = 'ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘... (ë§ì”€ í›„ 2.5ì´ˆ ì¹¨ë¬µ ì‹œ ìë™ ì™„ë£Œ)';
      }
    } else {
      document.getElementById('voice-status').textContent = 'âŒ¨ï¸ ë‹µë³€ì„ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”';
    }

    // íƒ€ì´ë¨¸
    if (config.timeLimitEnabled) {
      timerRemaining = config.timeLimitSec;
      updateTimerRing(document.getElementById('timer-ring'), timerRemaining, config.timeLimitSec);
      timerInterval = setInterval(() => {
        if (isPaused) return;
        timerRemaining -= 0.1;
        updateTimerRing(document.getElementById('timer-ring'), timerRemaining, config.timeLimitSec);
        if (timerRemaining <= 10 && timerRemaining > 9.9)
          showToast('â° 10ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤', 'warn');
        if (timerRemaining <= 0) {
          clearInterval(timerInterval);
          finalizeAnswer(startTime, resolve);
        }
      }, 100);
    }

    // STT ë¬´ìŒ ê°ì§€ â†’ ìë™ ì™„ë£Œ
    speechService.onSilence = () => {
      if (sessionState !== 'listening') return;
      clearInterval(timerInterval);
      finalizeAnswer(startTime, resolve);
    };

    // ì™¸ë¶€ì—ì„œ resolve ì ‘ê·¼ìš©
    window._resolveAnswer = (forced) => {
      clearInterval(timerInterval);
      finalizeAnswer(startTime, resolve);
    };
  });
}

function finalizeAnswer(startTime, resolve) {
  if (sessionState !== 'listening') return;
  sessionState = 'processing';

  speechService.stopListening();
  const text = config.typingMode
    ? (window._typingAnswer || '')
    : speechService.transcript;

  currentAnswer.answerText = text;
  currentAnswer.duration   = (Date.now() - startTime) / 1000;
  currentAnswer.fillerCount = countFillerWords(text);
  const struct = analyzeAnswerStructure(text);
  Object.assign(currentAnswer, struct);

  // ì‹œì„  ë¹„ìœ¨
  currentAnswer.gazeRatio = gazeScores.length
    ? gazeScores.reduce((a,b)=>a+b,0) / gazeScores.length : 0;
  gazeScores = [];

  document.getElementById('user-answer-area').classList.remove('listening');
  document.getElementById('listen-indicator').innerHTML = '';
  document.getElementById('voice-status').textContent = '';
  document.getElementById('btn-skip').disabled = true;
  window._typingAnswer = '';

  resolve(currentAnswer);
}

// â”€â”€ í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._typingAnswer = '';
function submitTextAnswer() {
  const input = document.getElementById('text-answer-input');
  window._typingAnswer = input.value.trim();
  document.getElementById('user-answer-area').textContent = window._typingAnswer;
  input.value = '';
  window._resolveAnswer?.();
}

// â”€â”€ ë²„íŠ¼ í•¸ë“¤ëŸ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skipQuestion() {
  window._resolveAnswer?.();
}

function togglePause() {
  isPaused = !isPaused;
  document.getElementById('pause-overlay').style.display = isPaused ? 'flex' : 'none';
  document.getElementById('btn-pause').textContent = isPaused ? 'â–¶ ì¬ê°œ' : 'â¸ ì¼ì‹œì •ì§€';
  if (isPaused) speechService.stopSpeaking();
}

function waitIfPaused() {
  return new Promise(resolve => {
    if (!isPaused) { resolve(); return; }
    const check = setInterval(() => { if (!isPaused) { clearInterval(check); resolve(); }}, 200);
  });
}

function confirmAbort() {
  document.getElementById('pause-overlay').style.display = 'none';
  document.getElementById('abort-overlay').style.display = 'flex';
}
function closeAbortDialog() {
  document.getElementById('abort-overlay').style.display = 'none';
  if (isPaused) document.getElementById('pause-overlay').style.display = 'flex';
}
function abortSession() {
  document.getElementById('abort-overlay').style.display = 'none';
  finalizeSession();
}

function onReducePressure() {
  pressureReduced = true;
  activePanel = activePanel.filter(id => id !== 'stress' && id !== 'citizen');
  if (activePanel.length === 0) activePanel = ['supportive', 'rational'];
  renderAvatarPanel();
  showToast('ì••ë°• ê°•ë„ë¥¼ ë‚®ì·„ìŠµë‹ˆë‹¤', 'success');
  showRealtime('ì••ë°• ê°•ë„ë¥¼ ë‚®ì·„ìŠµë‹ˆë‹¤. í¸ì•ˆí•˜ê²Œ ê³„ì†í•˜ì„¸ìš”.', 4000);
}

// â”€â”€ ì•ˆì „ ì¥ì¹˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSafety(msg) {
  document.getElementById('safety-msg').textContent = msg;
  document.getElementById('safety-overlay').style.display = 'flex';
}
function closeSafety() {
  document.getElementById('safety-overlay').style.display = 'none';
}

// â”€â”€ ì‹¤ì‹œê°„ í”¼ë“œë°± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showRealtime(msg, duration = 3000) {
  const el = document.getElementById('realtime-feedback');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), duration);
}

// â”€â”€ ì–¼êµ´ ê°ì§€ ì½œë°± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onFaceResult(result) {
  const pip = document.getElementById('pip-camera');
  const text = document.getElementById('face-status-text');

  if (result.faceDetected) {
    pip.style.borderColor = result.isLookingAtCamera ? 'var(--success)' : 'var(--warn)';
    text.textContent = result.isLookingAtCamera ? 'âœ“ ì •ë©´ ì‘ì‹œ' : 'ì¹´ë©”ë¼ë¥¼ ë´ì£¼ì„¸ìš”';
    if (sessionState === 'listening') gazeScores.push(result.gazeScore);
    if (!result.isLookingAtCamera && sessionState === 'listening')
      showRealtime('ì¹´ë©”ë¼ë¥¼ ë´ì£¼ì„¸ìš”', 2000);
  } else {
    pip.style.borderColor = 'var(--danger)';
    text.textContent = 'ì–¼êµ´ ë¯¸ê°ì§€';
    if (sessionState === 'listening') showRealtime('ì¹´ë©”ë¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”', 2000);
  }
}

// â”€â”€ í•„ëŸ¬ì›Œë“œ ì¹´ìš´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateFillerCount(text) {
  const cnt = countFillerWords(text);
  document.getElementById('filler-count').textContent = totalFillerCount + cnt;
}

// â”€â”€ UI í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setBubble(html, isSpeaking) {
  const el = document.getElementById('interviewer-bubble');
  el.innerHTML = html;
  el.classList.toggle('speaking', !!isSpeaking);
}

function updateProgress() {
  const total = questions.length;
  const current = currentQIdx + 1;
  document.getElementById('q-counter').textContent = `Q ${current} / ${total}`;
  document.getElementById('q-progress-text').textContent = `ì§ˆë¬¸ ${current} / ${total}`;
  document.getElementById('progress-fill').style.width = ((current / total) * 100) + '%';
}

// â”€â”€ ê²½ê³¼ ì‹œê°„ íƒ€ì´ë¨¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startElapsedTimer() {
  elapsedInterval = setInterval(() => {
    if (!isPaused) {
      sessionElapsed++;
      document.getElementById('session-elapsed').textContent = formatTime(sessionElapsed);
    }
  }, 1000);
}

// â”€â”€ ë©´ì ‘ê´€ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectSpeaker(q) {
  if (q?.preferred && activePanel.includes(q.preferred)) return q.preferred;
  return activePanel[currentQIdx % activePanel.length];
}

// â”€â”€ ì„¸ì…˜ ì¢…ë£Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function finalizeSession() {
  sessionState = 'done';
  clearInterval(timerInterval);
  clearInterval(elapsedInterval);
  speechService.stopListening();
  speechService.stopSpeaking();
  faceService?.stopCamera();

  // ê¸°ë¡ ëˆ„ì 
  totalFillerCount = answerRecords.reduce((s, a) => s + (a.fillerCount || 0), 0);

  const report = {
    sessionId: Date.now().toString(),
    startTime: new Date(Date.now() - sessionElapsed * 1000).toISOString(),
    endTime:   new Date().toISOString(),
    duration:  sessionElapsed,
    difficulty: config.difficulty,
    mode:       config.mode,
    answers:    answerRecords,
    gazeScore:  answerRecords.length ? answerRecords.reduce((s,a)=>s+(a.gazeRatio||0),0)/answerRecords.length : 0,
    fillerWordRate: answerRecords.length ? totalFillerCount / answerRecords.length : 0,
    avgResponseTime: answerRecords.length ? answerRecords.reduce((s,a)=>s+(a.duration||0),0)/answerRecords.length : 0,
    contentScore:0, logicScore:0, clarityScore:0, pressureScore:0,
    overallFeedback:'', strengths:[], improvements:[],
  };

  APP.setSessionReport(report);

  // ë¦¬í¬íŠ¸ ìƒì„± (Claude)
  document.getElementById('loading-overlay').style.display = 'flex';
  claudeAgent.generateFeedback(report)
    .then(fb => {
      Object.assign(report, fb);
      APP.setSessionReport(report);
    })
    .catch(err => {
      report.overallFeedback = 'AI í”¼ë“œë°± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
      APP.setSessionReport(report);
    })
    .finally(() => goTo('report.html'));
}

// â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
