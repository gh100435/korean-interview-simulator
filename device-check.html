<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¥ì¹˜ ì ê²€ â€” ì••ë°•ë©´ì ‘ ì‹œë®¬ë ˆì´í„°</title>
<link rel="stylesheet" href="css/style.css">
<style>
  .check-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media(max-width:600px){ .check-grid { grid-template-columns:1fr; } }

  .check-row { display:flex; align-items:center; gap:10px; padding:10px 0;
               border-bottom:1px solid var(--border); }
  .check-row:last-child { border-bottom:none; }
  .check-label { flex:1; font-size:13px; }
  .check-result { font-size:12px; font-weight:600; }

  #camera-preview-box {
    width:100%; aspect-ratio:4/3; background:#000;
    border-radius:10px; overflow:hidden; position:relative;
  }
  #camera-video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
  #face-overlay { position:absolute; inset:0; pointer-events:none; }
  .cam-badge { position:absolute; bottom:8px; left:8px; padding:3px 10px;
               border-radius:10px; font-size:11px; font-weight:700;
               background:rgba(0,0,0,.75); }

  .mic-meter { display:flex; align-items:flex-end; gap:2px; height:32px; padding:4px 0; }
  .mic-bar { width:5px; height:6px; background:var(--border); border-radius:2px;
             transition:height .08s; }
  .mic-bar.active { background:var(--success); }

  .fallback-note { background:rgba(224,82,82,.1); border:1px solid rgba(224,82,82,.3);
                   border-radius:8px; padding:10px 14px; font-size:12px;
                   color:var(--danger); margin-top:8px; }

  .nav-row { display:flex; gap:12px; justify-content:flex-end; margin-top:24px; }
</style>
</head>
<body>

<header class="page-header">
  <button class="btn btn-ghost" style="padding:6px 12px" onclick="goTo('index.html')">â† ë’¤ë¡œ</button>
  <span class="logo-text" style="margin-left:8px">ì¥ì¹˜ <span>ì ê²€</span></span>
</header>

<div class="container">

  <div class="check-grid">

    <!-- ì¹´ë©”ë¼ -->
    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">ğŸ“· ì¹´ë©”ë¼</div>
      <div id="camera-preview-box">
        <video id="camera-video" autoplay muted playsinline></video>
        <canvas id="face-overlay"></canvas>
        <div class="cam-badge" id="face-badge">ê°ì§€ ëŒ€ê¸° ì¤‘...</div>
      </div>
      <div style="margin-top:12px">
        <div class="check-row">
          <span class="status-dot" id="dot-camera"></span>
          <span class="check-label">ì¹´ë©”ë¼ ê¶Œí•œ</span>
          <span class="check-result" id="res-camera">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="check-row">
          <span class="status-dot" id="dot-face"></span>
          <span class="check-label">ì–¼êµ´ ê°ì§€</span>
          <span class="check-result" id="res-face">ëŒ€ê¸°</span>
        </div>
        <div class="check-row">
          <span class="status-dot" id="dot-gaze"></span>
          <span class="check-label">ì¹´ë©”ë¼ ì‘ì‹œ</span>
          <span class="check-result" id="res-gaze">ëŒ€ê¸°</span>
        </div>
      </div>
      <div id="camera-fallback" class="fallback-note" style="display:none">
        ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
        ìë§‰ ëª¨ë“œë¡œ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        <br><button class="btn btn-ghost" style="margin-top:8px;font-size:11px"
          onclick="skipCamera()">ì¹´ë©”ë¼ ì—†ì´ ê³„ì†</button>
      </div>
      <div id="camera-guide" style="font-size:11px;color:var(--text-sub);margin-top:8px"></div>
    </div>

    <!-- ë§ˆì´í¬ -->
    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">ğŸ¤ ë§ˆì´í¬</div>

      <div class="check-row">
        <span class="status-dot" id="dot-mic"></span>
        <span class="check-label">ë§ˆì´í¬ ê¶Œí•œ</span>
        <span class="check-result" id="res-mic">í™•ì¸ ì¤‘...</span>
      </div>
      <div class="check-row">
        <span class="status-dot" id="dot-stt"></span>
        <span class="check-label">ìŒì„± ì¸ì‹(STT)</span>
        <span class="check-result" id="res-stt">ëŒ€ê¸°</span>
      </div>
      <div class="check-row">
        <span class="status-dot" id="dot-tts"></span>
        <span class="check-label">TTS ìŒì„± ì¶œë ¥</span>
        <span class="check-result" id="res-tts">ëŒ€ê¸°</span>
      </div>

      <div style="margin-top:14px">
        <div style="font-size:11px;color:var(--text-sub);margin-bottom:6px">ë§ˆì´í¬ ë ˆë²¨</div>
        <div class="mic-meter" id="mic-meter">
          <div class="mic-bar" id="mb0"></div>
          <div class="mic-bar" id="mb1"></div>
          <div class="mic-bar" id="mb2"></div>
          <div class="mic-bar" id="mb3"></div>
          <div class="mic-bar" id="mb4"></div>
          <div class="mic-bar" id="mb5"></div>
          <div class="mic-bar" id="mb6"></div>
          <div class="mic-bar" id="mb7"></div>
          <div class="mic-bar" id="mb8"></div>
          <div class="mic-bar" id="mb9"></div>
        </div>
        <button class="btn btn-ghost" id="btn-mic-test"
          style="font-size:12px;padding:7px 14px;margin-top:8px"
          onclick="toggleMicTest()">ğŸ¤ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸</button>
      </div>

      <div style="margin-top:14px">
        <div style="font-size:11px;color:var(--text-sub);margin-bottom:6px">TTS í…ŒìŠ¤íŠ¸</div>
        <button class="btn btn-ghost" style="font-size:12px;padding:7px 14px"
          onclick="testTTS()">ğŸ”Š ìŒì„± ì¬ìƒ</button>
      </div>

      <div id="mic-fallback" class="fallback-note" style="display:none">
        ë§ˆì´í¬ ë˜ëŠ” STTë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë“œë¡œ ìë™ ì „í™˜ë©ë‹ˆë‹¤.
      </div>
    </div>

  </div>

  <!-- ì¡°ëª…/í™˜ê²½ ê°€ì´ë“œ -->
  <div class="card" style="margin-top:16px">
    <div style="font-size:13px;font-weight:700;margin-bottom:12px">ğŸ’¡ í™˜ê²½ ê°€ì´ë“œ</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;font-size:12px;color:var(--text-sub)">
      <div>ğŸ“ ì¹´ë©”ë¼ì™€ ëˆˆë†’ì´ ë§ì¶”ê¸°</div>
      <div>ğŸ’¡ ë°ì€ ì¡°ëª… (ì—­ê´‘ í”¼í•˜ê¸°)</div>
      <div>ğŸ”‡ ì¡°ìš©í•œ í™˜ê²½ (ì—ì½” ì£¼ì˜)</div>
      <div>ğŸ‘” ì •ì¥ ì°©ìš© ê¶Œì¥</div>
    </div>
  </div>

  <!-- ì„¸ì…˜ ìš”ì•½ -->
  <div class="card" style="margin-top:16px" id="session-summary">
    <div style="font-size:13px;font-weight:700;margin-bottom:10px">ğŸ“‹ ì„¸ì…˜ ì„¤ì • ìš”ì•½</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap" id="summary-badges"></div>
  </div>

  <div class="nav-row">
    <button class="btn btn-ghost" onclick="goTo('index.html')">â† ì„¤ì • ë³€ê²½</button>
    <button class="btn btn-primary" id="btn-start" onclick="startInterview()" disabled>
      ë©´ì ‘ ì‹œì‘ â†’
    </button>
  </div>

</div>

<div id="toast-container"></div>

<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/speech.js"></script>
<script src="js/face.js"></script>

<script>
  const config = APP.getSessionConfig();
  let cameraOk = false, micOk = false;
  let micStream = null, micContext = null, micAnimId = null;
  let isMicTesting = false;
  let faceService = null;

  // â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.onload = async () => {
    renderSummary();
    await initCamera();
    await initMic();
    checkReady();
  };

  window.onunload = () => {
    faceService?.stopCamera();
    if (micContext) micContext.close();
    if (micStream) micStream.getTracks().forEach(t => t.stop());
  };

  function renderSummary() {
    const diffLabel = { easy:'í•˜(ì‰¬ì›€)', medium:'ì¤‘(ë³´í†µ)', hard:'ìƒ(ì–´ë ¤ì›€)' }[config.difficulty];
    const modeLabel = { public_servant:'ê³µë¬´ì›', public_corp:'ê³µê¸°ì—…', mixed:'í˜¼í•©' }[config.mode];
    const badges = [
      `<span class="badge badge-${config.difficulty}">${diffLabel}</span>`,
      `<span class="badge" style="background:rgba(79,142,247,.15);color:var(--accent)">${modeLabel}</span>`,
      config.timeLimitEnabled ? `<span class="badge" style="background:rgba(224,154,58,.1);color:var(--warn)">ì‹œê°„ ì œí•œ: ${config.timeLimitSec}ì´ˆ</span>` : '',
      config.subtitleOnly ? `<span class="badge" style="background:var(--bg-card2);color:var(--text-sub)">ìë§‰ ì „ìš©</span>` : '',
      config.typingMode ? `<span class="badge" style="background:var(--bg-card2);color:var(--text-sub)">í…ìŠ¤íŠ¸ ì…ë ¥</span>` : '',
    ].filter(Boolean).join('');
    document.getElementById('summary-badges').innerHTML = badges;
  }

  // â”€â”€ ì¹´ë©”ë¼ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initCamera() {
    const videoEl  = document.getElementById('camera-video');
    const canvasEl = document.getElementById('face-overlay');
    faceService = new FaceDetectionService(videoEl, canvasEl);

    const ok = await faceService.startCamera();
    setDot('dot-camera', ok ? 'ok' : 'error');
    document.getElementById('res-camera').textContent = ok ? 'í—ˆìš©ë¨' : 'ê±°ë¶€ë¨';

    if (ok) {
      cameraOk = true;
      document.getElementById('camera-fallback').style.display = 'none';
      faceService.onResult = onFaceResult;
      await faceService.initFaceMesh();
    } else {
      document.getElementById('camera-fallback').style.display = 'block';
      setDot('dot-face', 'error');
      setDot('dot-gaze', 'error');
      document.getElementById('res-face').textContent = 'ì¹´ë©”ë¼ ì—†ìŒ';
      document.getElementById('res-gaze').textContent = 'ì¹´ë©”ë¼ ì—†ìŒ';
    }
  }

  function onFaceResult(result) {
    const badge = document.getElementById('face-badge');
    const camBox = document.querySelector('#camera-preview-box');
    if (result.faceDetected) {
      setDot('dot-face', 'ok');
      document.getElementById('res-face').textContent = 'ê°ì§€ë¨';
      if (result.isLookingAtCamera) {
        setDot('dot-gaze', 'ok');
        document.getElementById('res-gaze').textContent = 'ì‘ì‹œ ì¤‘';
        badge.textContent = 'âœ“ ì–¼êµ´ ì¸ì‹ë¨';
        badge.style.color = 'var(--success)';
        document.getElementById('camera-guide').textContent = 'í™˜ê²½ì´ ì ì ˆí•©ë‹ˆë‹¤.';
      } else {
        setDot('dot-gaze', 'warn');
        document.getElementById('res-gaze').textContent = 'ì‹œì„  ì´íƒˆ';
        badge.textContent = 'ì¹´ë©”ë¼ë¥¼ ì •ë©´ìœ¼ë¡œ ë´ì£¼ì„¸ìš”';
        badge.style.color = 'var(--warn)';
      }
    } else {
      setDot('dot-face', 'warn');
      setDot('dot-gaze', 'warn');
      document.getElementById('res-face').textContent = 'ë¯¸ê°ì§€';
      document.getElementById('res-gaze').textContent = 'ë¯¸ê°ì§€';
      badge.textContent = 'ì–¼êµ´ì„ í™”ë©´ì— ë§ì¶°ì£¼ì„¸ìš”';
      badge.style.color = 'var(--warn)';
      document.getElementById('camera-guide').textContent = 'ì¡°ëª…ì„ ë°ê²Œ í•˜ê³ , ì¹´ë©”ë¼ ê°€ê¹Œì´ ì•‰ì•„ì£¼ì„¸ìš”.';
    }
    checkReady();
  }

  // â”€â”€ ë§ˆì´í¬ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initMic() {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      micOk = true;
      setDot('dot-mic', 'ok');
      document.getElementById('res-mic').textContent = 'í—ˆìš©ë¨';
    } catch {
      setDot('dot-mic', 'error');
      document.getElementById('res-mic').textContent = 'ê±°ë¶€ë¨';
      document.getElementById('mic-fallback').style.display = 'block';
    }

    // STT ì§€ì› ì—¬ë¶€
    const sttOk = speechService.isAvailable;
    setDot('dot-stt', sttOk ? 'ok' : 'warn');
    document.getElementById('res-stt').textContent = sttOk ? 'ì§€ì›ë¨' : 'ë¯¸ì§€ì›(í…ìŠ¤íŠ¸ëª¨ë“œ)';

    // TTS ì§€ì› ì—¬ë¶€
    const ttsOk = speechService.isTTSAvailable;
    setDot('dot-tts', ttsOk ? 'ok' : 'warn');
    document.getElementById('res-tts').textContent = ttsOk ? 'ì§€ì›ë¨' : 'ë¯¸ì§€ì›(ìë§‰ëª¨ë“œ)';

    checkReady();
  }

  // â”€â”€ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleMicTest() {
    const btn = document.getElementById('btn-mic-test');
    if (!isMicTesting) {
      if (!micStream) { showToast('ë§ˆì´í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'warn'); return; }
      micContext = new AudioContext();
      const src = micContext.createMediaStreamSource(micStream);
      const analyser = micContext.createAnalyser();
      analyser.fftSize = 256;
      src.connect(analyser);
      isMicTesting = true;
      btn.textContent = 'â¹ í…ŒìŠ¤íŠ¸ ì¤‘ì§€';
      const data = new Uint8Array(analyser.frequencyBinCount);
      const bars = document.querySelectorAll('.mic-bar');
      const animate = () => {
        if (!isMicTesting) return;
        analyser.getByteFrequencyData(data);
        const avg = data.reduce((a,b)=>a+b,0) / data.length / 255;
        bars.forEach((bar, i) => {
          const h = Math.max(4, data[i * 3] / 255 * 28);
          bar.style.height = h + 'px';
          bar.classList.toggle('active', avg > 0.02);
        });
        micAnimId = requestAnimationFrame(animate);
      };
      animate();
    } else {
      isMicTesting = false;
      cancelAnimationFrame(micAnimId);
      btn.textContent = 'ğŸ¤ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸';
      document.querySelectorAll('.mic-bar').forEach(b => {
        b.style.height = '6px'; b.classList.remove('active');
      });
    }
  }

  function testTTS() {
    speechService.speak('ì•ˆë…•í•˜ì„¸ìš”. ë©´ì ‘ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤. ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ?', 'authority');
  }

  // â”€â”€ í´ë°± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function skipCamera() {
    cameraOk = true; // ì—†ì–´ë„ ì§„í–‰ í—ˆìš©
    config.subtitleOnly = true;
    APP.setSessionConfig(config);
    document.getElementById('camera-fallback').style.display = 'none';
    showToast('ì¹´ë©”ë¼ ì—†ì´ ì§„í–‰í•©ë‹ˆë‹¤', 'info');
    checkReady();
  }

  // â”€â”€ ì‹œì‘ ê°€ëŠ¥ ì—¬ë¶€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function checkReady() {
    // ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‹œì‘ í—ˆìš©
    // ë‘˜ ë‹¤ ì—†ì–´ë„ í…ìŠ¤íŠ¸ ëª¨ë“œë©´ í—ˆìš©
    const ready = true; // MVP: í•­ìƒ ì‹œì‘ í—ˆìš© (ê¶Œí•œ ì—†ì–´ë„ í´ë°±ìœ¼ë¡œ ì§„í–‰)
    document.getElementById('btn-start').disabled = false;
  }

  // â”€â”€ ë©´ì ‘ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startInterview() {
    faceService?.stopCamera();
    if (micContext) micContext.close();
    // ë§ˆì´í¬ ê¶Œí•œ ì—†ìœ¼ë©´ íƒ€ì´í•‘ ëª¨ë“œ ê°•ì œ
    if (!micOk) { config.typingMode = true; APP.setSessionConfig(config); }
    goTo('interview.html');
  }

  // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setDot(id, state) {
    const el = document.getElementById(id);
    if (!el) return;
    el.className = 'status-dot ' + state;
  }
</script>
</body>
</html>
